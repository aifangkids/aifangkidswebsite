<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">產品詳細資訊</title>
    
    <style>
        /* ------------------------------------
            通用樣式（與 index.html 保持一致）
        ------------------------------------ */
        @import url('https://fonts.googleapis.com/css2?family=Huninn&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Huninn', 'Noto Sans TC', Arial, sans-serif; 
            color: #333;
            background-color: #fff;
            line-height: 1.5;
            font-size: 14px; 
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }
        
        button {
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
            font-family: inherit;
        }

        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* ------------------------------------
            導航列 (Navbar)
        ------------------------------------ */
        #navbar {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo a {
            font-size: 24px;
            font-weight: bold;
            color: #e91e63;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-links a {
            text-transform: uppercase;
            font-size: 14px;
            padding: 5px 0;
            position: relative;
        }

        .nav-icons {
            display: flex;
            gap: 15px;
            font-size: 18px;
        }

        /* ------------------------------------
            產品詳情區 (Detail)
        ------------------------------------ */
        #product-detail-area {
            padding: 40px 0;
        }
        
        /* 預設隱藏，只顯示載入狀態，載入後再顯示 product-wrapper */
        .product-wrapper {
            display: none; 
            gap: 50px;
            flex-wrap: wrap;
        }

        .image-gallery {
            flex: 1 1 40%;
            min-width: 300px;
        }

        .main-image-box img {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid #eee;
        }

        .gallery-thumbs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .gallery-thumbs img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: border-color 0.2s;
        }

        .gallery-thumbs img:hover,
        .gallery-thumbs img.active {
            border-color: #e91e63;
        }

        .product-info-wrapper {
            flex: 1 1 50%;
            min-width: 300px;
        }

        .product-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .brand-name {
            display: block;
            font-size: 16px;
            color: #777;
            margin-bottom: 15px;
        }

        .price-box {
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .original-price {
            color: #999;
            text-decoration: line-through;
            margin-right: 15px;
        }

        .discount-price {
            color: #e91e63;
            font-size: 24px;
            font-weight: bold;
        }

        .options-section {
            margin-bottom: 30px;
        }
        
        .option-label {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }
        
        .size-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .size-option-wrapper input[type="radio"] {
            display: none;
        }
        
        .size-option-wrapper label {
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            font-size: 14px;
        }
        
        .size-option-wrapper input[type="radio"]:checked + label {
            background-color: #e91e63;
            color: #fff;
            border-color: #e91e63;
        }

        .size-option-wrapper label.disabled {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .add-to-cart-btn {
            background-color: #e91e63;
            color: #fff;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            width: 100%;
            transition: background-color 0.3s;
        }

        .add-to-cart-btn:hover {
            background-color: #c2185b;
        }

        /* 產品描述和資訊 */
        .product-details {
            /* 修正: 載入後顯示，不需要預設 display: none */
            margin-top: 50px;
            border-top: 1px solid #eee;
            padding-top: 30px;
        }

        .details-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #777;
            position: relative;
        }

        .tab-button.active {
            color: #e91e63;
            border-bottom: 2px solid #e91e63;
            margin-bottom: -2px; 
        }

        .product-description, .product-notes {
            line-height: 1.8;
            padding: 10px 0;
            font-size: 15px;
        }
        
        .product-notes {
            color: #888;
            font-style: italic;
        }
        
        .hidden {
            display: none;
        }
        
        /* Loading 樣式 */
        .loading-state {
            text-align: center;
            padding: 100px 0;
            font-size: 18px;
            color: #777;
        }

        /* ------------------------------------
            Footer - 保持與 index.txt 一致
        ------------------------------------ */
        #footer {
            background-color: #333;
            color: #fff;
            padding: 30px 0;
            margin-top: 50px;
        }

        .footer-cols {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .copyright {
            border-top: 1px solid #555;
            padding-top: 15px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    
    <header id="navbar">
        <div class="wrapper nav-content">
            <div class="logo">
                <a href="index.html">AIFANG KIDS</a>
            </div>
            <nav class="nav-links">
                <a href="index.html">ALL</a>
                <a href="#">上衣</a>
                <a href="#">下著</a>
                <a href="#">外套</a>
            </nav>
            <div class="nav-icons">
                <a href="#"><i class="fas fa-search"></i></a>
                <a href="cart.html"><i class="fas fa-shopping-cart"></i></a>
                <a href="#"><i class="fas fa-user"></i></a>
            </div>
        </div>
    </header>

    <div id="product-detail-area" class="wrapper">
        <div class="loading-state" id="loading-state">產品資訊載入中...</div>
        
        <div class="product-wrapper" id="product-wrapper">
            <div class="image-gallery">
                <div class="main-image-box">
                    <img id="main-image" src="" alt="主要產品圖片">
                </div>
                <div class="gallery-thumbs" id="gallery-thumbs">
                    </div>
            </div>

            <div class="product-info-wrapper">
                <div class="product-header">
                    <h1 id="product-name"></h1>
                    <span class="brand-name" id="product-brand"></span>
                </div>

                <div class="price-box">
                    <span class="original-price" id="original-price"></span>
                    <span class="discount-price" id="sale-price"></span>
                </div>
                
                <div class="options-section">
                    <span class="option-label">尺寸/顏色選擇:</span>
                    <div class="size-selection" id="size-options">
                        </div>
                </div>

                <button class="add-to-cart-btn">加入購物車</button>
            </div>
        </div>

        <div class="product-details" id="product-details-content">
            <div class="details-tabs">
                <button class="tab-button active" data-tab="description">商品描述</button>
                <button class="tab-button" data-tab="notes">注意事項</button>
            </div>
            
            <div class="tab-content description-content" id="product-description-content">
                <div id="product-description" class="product-description"></div>
            </div>
            
            <div class="tab-content notes-content hidden" id="product-notes-content">
                <div id="product-notes" class="product-notes"></div>
            </div>
        </div>
    </div>
    
    <footer id="footer">
        <div class="wrapper footer-cols">
            <div class="customer-center">
                <h3>CUSTOMER CENTER</h3>
                <p>MAIL: aifangkids@gmail.com</p>
                <p>服務時間: AM 10:00 - PM 21:00</p>
                <p>週末與國定假日休息，訂單及出貨將於工作日為您處理</p>
            </div>
            <div class="company-info">
                <h3>COMPANY INFO</h3>
                <p>公司名稱: 璦坊童裝</p>
                <p>統一編號: 95294390</p>
            </div>
        </div>
        <div class="copyright wrapper">
            <p>Copyright © **Aifang Kids Studio** All rights reserved.</p>
        </div>
    </footer>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        // =========================================================
        // 修正點 1: 整合您的 Google Apps Script URL
        // =========================================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxj1KQbiB3Q4aJAIJDJ_LcIbddkkrBNeCS_J1Wo44JbGZW6KpjmhmHxemURciWA8p6QyA/exec'; 
        
        // 預設圖片（如果 MainImage_URL 為空時使用）
        const defaultImage = 'placeholder.jpg'; 

        let cart = []; // 購物車陣列
        let currentProduct = null; // 儲存當前產品資料

        /**
         * 購物車管理函數 (從 localStorage 載入和儲存)
         */
        function loadCart() {
            const cartJson = localStorage.getItem('shoppingCart');
            cart = cartJson ? JSON.parse(cartJson) : [];
        }

        function saveCart() {
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
        }
        
        /**
         * 從 URL 獲取查詢參數
         */
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        /**
         * 處理 Tab 切換邏輯
         */
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const descriptionContent = document.getElementById('product-description-content');
            const notesContent = document.getElementById('product-notes-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    descriptionContent.classList.add('hidden');
                    notesContent.classList.add('hidden');

                    const tab = this.getAttribute('data-tab');
                    if (tab === 'description') {
                        descriptionContent.classList.remove('hidden');
                    } else if (tab === 'notes') {
                        notesContent.classList.remove('hidden');
                    }
                });
            });
        }

        /**
         * 渲染單一產品的詳細資訊
         * 修正點 2: 修正所有欄位名稱為大寫，並使用正確的 ID 欄位 Code
         * @param {Object} product - 產品資料物件
         */
        function renderProductDetail(product) {
            if (!product || !product.Code) {
                document.getElementById('product-wrapper').style.display = 'none';
                document.getElementById('loading-state').innerHTML = '<h1>找不到該產品資訊或資料不完整</h1>';
                document.getElementById('product-details-content').style.display = 'none';
                return;
            }

            // 顯示產品內容，隱藏載入狀態
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('product-wrapper').style.display = 'flex';
            document.getElementById('product-details-content').style.display = 'block';

            document.getElementById('page-title').textContent = `${product.Name} - ${product.Brand} 詳細資訊`;
            document.getElementById('product-name').textContent = product.Name || '無名稱';
            document.getElementById('product-brand').textContent = product.Brand || 'N/A';
            
            // 價格欄位修正
            const originalPrice = parseFloat(product.Price_Original) || 0;
            // 由於 JSON 中 Price-20%OFF 有 '-'，需要用方括號訪問
            const discountPrice = parseFloat(product['Price-20%OFF']) || 0; 
            
            document.getElementById('sale-price').textContent = discountPrice.toFixed(0) + ' TWD';
            document.getElementById('original-price').textContent = originalPrice.toFixed(0) + ' TWD';
            
            // 主圖 URL 修正
            const mainImageEl = document.getElementById('main-image');
            const mainImageUrl = product.MainImage_URL && product.MainImage_URL.trim() !== '' ? product.MainImage_URL.trim() : defaultImage;
            mainImageEl.src = mainImageUrl;
            mainImageEl.alt = product.Name || '產品圖片';
            
            // 描述和注意事項內容修正 (使用 JSON 中存在的欄位)
            const descriptionHtml = (product.Description || '無商品描述').replace(/\n/g, '<br>');
            document.getElementById('product-description').innerHTML = descriptionHtml;

            // 修正 Notes 欄位，使用 JSON 中存在的 Notes 欄位
            const notesHtml = (product.Notes || '無注意事項').replace(/\n/g, '<br>'); 
            document.getElementById('product-notes').innerHTML = notesHtml;
            
            // =========================================================
            // *** 修正圖片渲染邏輯 (合併 ColorImages 和 MainImages) ***
            // =========================================================
            const galleryThumbsEl = document.getElementById('gallery-thumbs');
            
            // 1. 建立圖片 URL 列表，並確保主圖是第一個元素
            const allImages = [];
            if (mainImageUrl !== defaultImage) {
                 allImages.push(mainImageUrl);
            }

            // 處理圖片列表欄位 (ColorImages, MainImages)
            const processImages = (imageList, targetArray) => {
                 if (imageList) {
                     const imageUrls = String(imageList)
                         .split('；') // 使用中文分號分隔
                         .map(s => s.trim())
                         .filter(url => url.length > 0 && url.startsWith('http')); // 確保是有效的 URL
                     
                     // 過濾掉重複的圖片 (包括主圖)
                     imageUrls.forEach(url => {
                        if (!targetArray.includes(url)) {
                            targetArray.push(url);
                        }
                     });
                 }
            };

            processImages(product.ColorImages, allImages); 
            processImages(product.MainImages, allImages); 

            // 渲染所有圖片縮圖
            if (galleryThumbsEl) {
                let galleryHtml = '';
                allImages.forEach((url, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    galleryHtml += `<img src="${url}" alt="${product.Name} 輔助圖片 ${index + 1}" data-full-image="${url}" class="thumb-image ${isActive}">`;
                });
                galleryThumbsEl.innerHTML = galleryHtml;

                // 設定點擊小圖換大圖的事件
                document.querySelectorAll('.thumb-image').forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        mainImageEl.src = this.getAttribute('data-full-image');
                        document.querySelectorAll('.thumb-image').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }

            // =========================================================
            // *** 修正尺寸選項解析邏輯 (使用 Sizes_Available) ***
            // =========================================================
            const sizesAvailable = product.Sizes_Available; // 使用 JSON 中的正確欄位名稱
            const sizeOptionsEl = document.getElementById('size-options');
            
            if (sizesAvailable && sizeOptionsEl) {
                // 修正解析邏輯：分隔符號是中文分號 (；)
                // 錯誤點修正: 變數名稱從 Available 修正為 sizesAvailable
                const sizeParts = String(sizesAvailable).split('；').map(s => s.trim()).filter(s => s.length > 0); 
                let optionsHtml = '';

                sizeParts.forEach((part, index) => {
                    // 格式: 尺寸-顏色/花紋-庫存
                    const partsArray = part.split('-');
                    if (partsArray.length < 3) return; 

                    const size = partsArray[0].trim(); 
                    const color = partsArray[1].trim(); 
                    const stock = parseInt(partsArray[2].trim()) || 0; 

                    // 詳細頁面統一使用折扣價
                    const optionPrice = discountPrice; 
                    const optionId = `size-option-${index}`;
                    const isDisabled = stock <= 0; 

                    optionsHtml += `
                        <div class="size-option-wrapper">
                            <input type="radio" name="size_color" id="${optionId}" 
                                value="${size} | ${color}" 
                                data-price="${optionPrice}" 
                                data-size="${size}" data-color="${color}" 
                                data-stock="${stock}"
                                ${isDisabled ? 'disabled' : ''}>
                            <label for="${optionId}" class="${isDisabled ? 'disabled' : ''}">
                                ${size} (${color}) 
                                ${isDisabled ? '(售罄)' : `(庫存: ${stock})`}
                            </label>
                        </div>
                    `;
                });
                sizeOptionsEl.innerHTML = optionsHtml;
            }
        }

        /**
         * *** 新增：加入購物車處理函數 ***
         */
        function handleAddToCart() {
            if (!currentProduct) {
                alert('產品資料尚未載入，請稍後再試。');
                return;
            }

            // 1. 檢查是否有選中尺寸/顏色
            const selectedOption = document.querySelector('input[name="size_color"]:checked');
            if (!selectedOption) {
                alert('請選擇尺寸和顏色。');
                return;
            }

            // 2. 獲取選中的選項數據
            const size = selectedOption.getAttribute('data-size');
            const color = selectedOption.getAttribute('data-color');
            const price = parseFloat(selectedOption.getAttribute('data-price'));
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            const qty = 1; // 預設數量為 1 

            if (stock < qty) {
                 alert('庫存不足，無法加入購物車。');
                 return;
            }

            // 3. 檢查購物車中是否已有相同 SKU (Code + 尺寸 + 顏色) 的商品
            const itemIndex = cart.findIndex(item => 
                item.code === currentProduct.Code && 
                item.displaySize === size && 
                item.color === color
            );

            if (itemIndex > -1) {
                // 已存在：數量加 1，但要確保不超過總庫存
                if (cart[itemIndex].qty + qty > stock) {
                    alert(`庫存僅剩 ${stock}，購物車中已有 ${cart[itemIndex].qty} 個，無法再加入。`);
                    return;
                }
                cart[itemIndex].qty += qty;
            } else {
                // 不存在：新增商品
                const newItem = {
                    name: currentProduct.Name, 
                    price: price, 
                    displaySize: size, 
                    color: color, 
                    code: currentProduct.Code, // 使用產品 Code 作為唯一 ID
                    qty: qty, 
                    selected: true,
                    imageUrl: currentProduct.MainImage_URL || defaultImage
                };
                cart.push(newItem);
            }

            // 4. 儲存購物車並給予提示
            saveCart();
            alert(`${currentProduct.Name} (尺寸: ${size}, 顏色: ${color}) 已成功加入購物車！`);
            // 可導向購物車頁面
            // window.location.href = 'cart.html'; 
        }

        /**
         * 頁面主邏輯：抓取資料並找到特定產品
         */
        async function loadProduct() {
            const productId = getUrlParam('id');
            const loadingState = document.getElementById('loading-state');
            
            if (!productId) {
                if(loadingState) loadingState.innerHTML = '<h1>錯誤：URL 中缺少產品 ID。</h1>';
                return;
            }
            
            try {
                const response = await fetch(GAS_URL);
                const products = await response.json(); 

                if (products && Array.isArray(products)) {
                    // 尋找匹配 Code 的產品
                    const product = products.find(p => String(p.Code).trim() === String(productId).trim());
                    
                    if (product) {
                        currentProduct = product; // *** 儲存當前產品資料供購物車使用 ***
                        
                        // 渲染頁面
                        renderProductDetail(product);
                        setupTabs(); 
                        
                        // *** 連接「加入購物車」按鈕事件 ***
                        const addToCartBtn = document.querySelector('.add-to-cart-btn');
                        if (addToCartBtn) {
                            addToCartBtn.removeEventListener('click', handleAddToCart); // 避免重複綁定
                            addToCartBtn.addEventListener('click', handleAddToCart);
                        }

                    } else {
                        if(loadingState) loadingState.innerHTML = `<div class="loading-state"><h1>找不到 ID 為 ${productId} 的產品。</h1></div>`;
                    }
                } else {
                    if(loadingState) loadingState.innerHTML = '<div class="loading-state"><h1>無法讀取產品資料庫。</h1></div>';
                }

            } catch (error) {
                console.error('載入產品詳情時發生錯誤:', error);
                if(loadingState) loadingState.innerHTML = '<div class="loading-state" style="color: red;"><h1>資料載入失敗，請檢查網路或 Apps Script URL。</h1></div>';
            }
        }

        // 頁面載入時執行
        window.onload = () => {
             loadCart(); // 先載入購物車資料
             loadProduct();
        };
    </script>
</body>
</html>