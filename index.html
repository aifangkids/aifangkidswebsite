// --- 核心配置 ---
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgCo9EajvenCtLsxrhtmJTYmZZdd7gHEkNxMOUyVUaui8W3_gKifiXByfR2zvjMgLg_XkRVhB-1_U1vvPSRnrNMIhA0mppvvyjeTpw4QcXsIXZGDokR_3xd56AVsJSOkdtbgCqGKL9oF1AlMWFvNbBl2nsE6ydj3CkNHbjdChZLSqFKYdrCOODWZ7Jdy0DFrp9ZGdaGe1MTBXvzbLduZq0XReD3riS97NFG0I-l76aAAfCeG006O2SBPV7oF994r4nwUYwA79gE4flO0iA7xzWbSI67QQ&lib=Mc6w9ccL94SXtnTspuIvQiP6P3xwH8FnN";

let allData = { products: [], details: [] };

// --- 視圖管理 ---
function showView(id) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
}

function openNav(id) {
    document.getElementById(id).classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

function closeAll() {
    document.querySelectorAll('.side-nav').forEach(s => s.classList.remove('active'));
    document.getElementById('overlay').style.display = 'none';
}

function toggleSub(id) {
    document.getElementById(id).classList.toggle('active');
}

// --- 1. 初始化：抓取 API 數據 ---
async function initApp() {
    try {
        const response = await fetch(API_URL);
        allData = await response.json();
        console.log("✅ 數據載入成功:", allData);
        
        renderProductList(allData.products);
        renderFilters(allData.products);
    } catch (error) {
        console.error("❌ API 載入失敗:", error);
    }
}

// --- 2. 渲染首頁列表 ---
function renderProductList(products) {
    const listContainer = document.querySelector('#page-index > div:last-child');
    if (!listContainer) return;

    listContainer.innerHTML = products.map(p => `
        <div class="p-card" onclick="loadProductDetail('${p.code}')">
            <img src="${p.mainImage}" style="width:100%; aspect-ratio:1/1; object-fit:cover;">
            <div style="text-align:center; padding:15px;">
                <div style="font-size:12px; color:#888;">${p.brand}</div>
                <div style="font-size:14px; margin:5px 0;">${p.name}</div>
                <div style="font-weight:bold;">NT$ ${p.sizes.bebe.salePrice} UP</div>
            </div>
        </div>
    `).join('');
}

// --- 3. 載入商品詳情 (由首頁點擊觸發) ---
function loadProductDetail(code) {
    // 從 details 分頁中找對應 code
    const detail = allData.details.find(d => d.code === code);
    if (!detail) return;

    const container = document.getElementById('page-detail');
    
    // 渲染尺寸按鈕 (活用 BEBE, KIDS, JUNIOR 價格)
    let sizeButtonsHTML = "";
    if (detail.sizes.bebe) sizeButtonsHTML += `<button class="s-btn baby" onclick="selectPrice(this, '${detail.sizes.bebe.salePrice}')">BEBE (${detail.sizes.bebe.options})<br><strong>NT$ ${detail.sizes.bebe.salePrice}</strong></button>`;
    if (detail.sizes.kids) sizeButtonsHTML += `<button class="s-btn kids" onclick="selectPrice(this, '${detail.sizes.kids.salePrice}')">KIDS (${detail.sizes.kids.options})<br><strong>NT$ ${detail.sizes.kids.salePrice}</strong></button>`;
    if (detail.sizes.junior) sizeButtonsHTML += `<button class="s-btn junior" onclick="selectPrice(this, '${detail.sizes.junior.salePrice}')">JUNIOR (${detail.sizes.junior.options})<br><strong>NT$ ${detail.sizes.junior.salePrice}</strong></button>`;

    // 渲染詳情圖 (由 detailurl1 ~ 15)
    const detailImagesHTML = detail.detailImages.map(img => `<img src="${img}" style="width:100%; margin-bottom:10px;">`).join('');

    container.innerHTML = `
        <div class="detail-container">
            <div style="flex:1.2;">
                <img src="${allData.products.find(p=>p.code===code).mainImage}" style="width:100%;">
                <div style="margin-top:30px;">${detailImagesHTML}</div>
            </div>
            <div style="flex:1; position:sticky; top:120px; height:fit-content;">
                <div style="border:1.5px solid #000; display:inline-block; padding:3px 12px; font-size:11px; font-weight:bold;">${detail.brand}</div>
                <h1 style="font-size:26px; margin:15px 0;">${detail.name}</h1>
                <p style="font-size:13px; color:#666; line-height:1.8;">${detail.description}</p>
                <p style="font-size:12px; color:#999;">材質: ${detail.material}</p>
                
                <div class="color-dots">
                    ${detail.colors.map(c => `<div class="dot" style="${c.value.startsWith('#') ? 'background:'+c.value : 'background:url('+c.value+') center/cover'}" title="${c.name}"></div>`).join('')}
                </div>

                <div id="active-price" style="font-size:24px; font-weight:700; margin:20px 0;">NT$ ${detail.sizes.bebe.salePrice}</div>

                <div class="styling-btn" onclick="alert('${detail.stylingtips}')">✨ Styling Tips</div>

                <div style="margin-top:30px;">
                    <p style="font-size:12px; font-weight:bold;">SELECT SIZE & PRICE</p>
                    <div class="size-btns">${sizeButtonsHTML}</div>
                </div>

                <button class="btn-black" style="margin-top:40px; width:100%; padding:20px; background:#000; color:#fff; border:none; font-weight:bold; cursor:pointer;" onclick="openNav('right-cart')">ADD TO SHOPPING BAG</button>
            </div>
        </div>
    `;
    
    showView('page-detail');
}

// 切換價格顯示
function selectPrice(btn, price) {
    document.querySelectorAll('.s-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('active-price').innerText = `NT$ ${price}`;
}

// --- 4. 側邊欄品牌篩選器 (從 Products 提取品牌) ---
function renderFilters(products) {
    const brands = [...new Set(products.map(p => p.brand))];
    const filterContainer = document.getElementById('sub-tops');
    filterContainer.innerHTML = brands.map(b => `
        <label class="brand-filter"><input type="checkbox" value="${b}"> ${b}</label>
    `).join('');
}

// 啟動程式
initApp();
